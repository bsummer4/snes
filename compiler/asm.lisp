"This is the code that actually creates the textual asm output.  "

(in-package #:cs400-compiler)

(always-eval
  (defparameter *annotations* nil))

(defparameter +addressing-modes-and-syntax+
  '((:implied "")
    (:accumulator "A")
    (:immediate "#b")
    (:immediate-w "#w")
    #| TODO What are the other kinds of 'immediate's? |#
    (:direct "b")
    (:direct-x-indexed "b,X")
    (:direct-y-indexed "b,Y")
    (:stack-indexed "b,S")
    (:direct-indirect "(b)")
    (:direct-indirect-long "[b]")
    (:direct-x-indexed-indirect "(b,X)")
    (:direct-indirect-y-indexed "(b),Y")
    (:direct-indirect-long-y-indexed "[b],Y")
    (:stack-relative-indirect-y-indexed "(b,S),Y")
    (:block-move "b,b")
    (:absolute "w")
    (:absolute-x-indexed "w,X")
    (:absolute-y-indexed "w,Y")
    (:absolute-indirect "(w)")
    (:absolute-indirect-long "[w]")
    (:absolute-x-indexed-indirect "(w,X)")
    (:long "l")
    (:long-x-indexed "l,X")))

(defvar *emit-indentation* 0)

(defun indent-chars ()
  (collecting
    (dotimes (i (* 4 *emit-indentation*))
      (collect #\space))))

(defun emit (string)
  (format t "狺狺アㄩ钿孱舡汨狎螬篝蜷铉鲠祯弩┅ㄤ彐磲泸鏖翳轭溴铘钺礤怙澌泔溴ㄩ犷铒翎糸镱螵啜戾è屙轸轭溴铘狒轱瞠ū屙轸轭溴铘狒轱瞠┅ㄦ矧磲狺狺ア蝈篝ㄩ钿孱舡汨狎螬К钺礤楞镤濠啜痱镧楞镤濠┅ㄤ彐躅狍憝篚怄矧磲ㄦ矧磲舡汨狎狎珲礤铘ㄥ豉疱汜箦狎珲礤铘簌礅镬簌礅镬钺礤狎珲礤铘┅铛礅弪ㄦ矧磲铋ㄥ汜箦骘蝽狒汨狎ǎ茆铂О猗ǎ荀船О鳍ǎ莒冬О膦┅狎珲礤铘┅┅ㄤ彐躅狍憝骘蝽狒ㄦ矧磲舡篝蜷铉蝈篝狎珲礤铘螬⒃犭犷狍骘蝽骝镯徜潋弩箝铉盹溴蟓犷洵簌铘狲犷箫礤狎珲屙孱趔蝈趱蝾轭翳泔蝌弩痫钿轭狍簌铘狲ㄣ镥蜚ㄦ灬趑孱祜镳骘汨狎徙蝻篌骘蝽狒篝蜷铉泔祆邈ㄩㄦ轭汨狎Ж＼＼＼飑ㄣ镥蜚ㄡ箜篚怄矧磲汨狎痫狎珲礤铘螬ъ轶舂扉篝汨狎┅┅篝蜷铉┅ㄤ彐躅狍ㄣ镯磲钿盹溴蝈篝狎珞ㄤ邈灬蝈脲黠蜾泔眄犷盹溴┅ㄥ黹ㄦ矧磲铋幄簌礅镬钺礤泔眄犷洎ㄡ痧禊＇狍憝骘蝽狒ㄣ狎ㄥ祜镫躔盹溴徜潋弩箝铉盹溴蟓犷洵簌铘狲┅狎珞┅┅蔑溴清铄蜥糸镱绎豸轭弩ㄡ祺狴蟓弼犰．啜痱镧括磲疸狎ㄦ畋戾舄è簌礅镬钺礤”┅簌礅镬疳汶徵”┅ㄦㄩ铘弪ㄦ矧磲铋幄瞟皓┅啜溴骢骖灬忮飑ㄥ黹ㄦ矧磲铋篝蜷铉躔汜箦ㄦ矧磲铋猃瞟灬忮飑┅┅Ж忮忸忭怵怛岍┅ㄤ彐躅レ徕屐钺礤ㄥ黹ㄦ矧磲铋Ⅺ猃钺礤┅ㄤ彐躅ョ雉灬忮飙钺礤ē怛灬忮飙钺礤┅ㄤ彐躅モ蜥钽璀殒铒灬忮飙钺礤ē忮灬忮飙钺礤┅ㄤ彐躅メ箜泔溴簌礅镬脲痱雉雉疱铋飑ㄥ黹ㄦ矧磲铋ㄩ痱雉雉疱Ｃ镤幄Ｃ镤猃簌礅镬钺礤簌礅镬┅┅ㄤ彐磲泸倍忾舡盹溴ī啜狍候屦洪眄邃獒翦ｘ嘲┅ㄤ彐磲泸腑忾舡盹溴ī啜狍后屦洪眄邃獒翦ｘ嘲┅ㄤ彐躅レ镝洵铛礅弪ㄤ邈灬蝈铛礅弪┅ㄡ箜红溽洪眄邃獒翦┅ㄤ彐磲泸黩轸瀛ㄡ滗鲠祯濠啜痱镧ㄡ箜红溽洪眄邃獒翦鲠祯濠ㄡ箜后翎轰轵邈徜潋┅ㄤ彐躅箦舡蝈箦舡栳钿戾鲠祯濠ㄥ黹ㄦ矧磲铋Ｄ狒ぐ昂破泼唑弩弭哞犷潇弪ぐ鞍褒鲠祯濠┅ㄤ彐躅ョ蝻鳝篝徙ㄡ盹躅舂麒孱痨躞犴秕铘鏖翳轭溴铘⑦珧秣轭邕翳暹篝徙擘ㄡ箜呼筱洪眇扉邃ㄡ箜后邈洪眇扉邃ㄡ箜后忏洪眄邃獒翦犴秕铘ㄡ箜呼泱洪眇扉邃┅┅ㄤ彐躅ン栩轭氕篝徙ㄡ盹躅舂麒孱痨躞犴秕铘鏖翳轭溴铘⑦箬蜷铍轭邕翳暹篝徙擘ㄡ箜呼筱洪眇扉邃ㄡ箜恒煦洪眇扉邃ㄡ箜横溷洪眄邃獒翦犴秕铘ㄡ箜呼泱洪眇扉邃┅┅ㄤ彐躅ン麸蝈徜潋ㄡ滗蝈篌篝矧徵瀛沆狍螬ㄥ汜箦篝矧徵瀛沆狍ê篝徙ㄡ箜后翎后翎汶轭溴邃徜潋弩螬ê珈镡犰ㄡ箜后翎横怏镬豸徜潋弩螬┅ㄤ彐躅レ镝洵徜潋ㄡ滗蝈篌篝矧徵瀛沆狍螬ㄥ汜箦篝矧徵瀛沆狍ê篝徙ㄡ箜红溽后翎汶轭溴邃徜潋弩螬ê珈镡犰ㄡ箜红溽横怏镬豸徜潋弩螬┅ㄤ彐躅ン鏖翥璀牾眇孱趄鲠祯翎蜱弭ㄤ邈灬蝈簌礅镬翎蜱弭铛礅弪鲠祯濠ē沩鲠祯濠ē忮翎蜱弭┅ㄤ彐躅ン翎镳弪犷洎ㄤ邈灬蝈扉篝镳弪犷洎ㄡ痧禊＇ン麸蝈徜潋蝈鲥蝮镳弪犷洎┅ㄤ彐躅レ溽镳弪犷洎ㄦ狎瀛磲翥桢蚝磲翥镳弪犷è镦豉疱铛礅弪ē祜徜铛礅弪镳弪犷洎è扉篝篝矧徵瀛沆狍徜潋ē祜徜徜潋徜潋篝矧徵瀛沆狍螬┅ㄤ彐躅ャ眇镳弪犷洎ㄦ狎瀛磲翥桢蚝磲翥镳弪犷è镦豉疱铛礅弪ㄡ箜恒眇洪眄邃獒翦镳弪犷洎è扉篝篝矧徵瀛沆狍徜潋ㄥ汜箦篝矧徵瀛沆狍ê篝徙ㄡ箜恒眇后翎汶轭溴邃徜潋┅ê珈镡犰ㄡ箜恒眇横怏镬豸徜潋┅┅┅ㄤ彐躅ョ雉锃殒浇灬忮飑ē熹ē沩ē忮灬忮飑ㄤ彐躅ョ雉锃殒〗灬忮飑ē熹ē沩ē忸灬忮飑ㄤ彐躅ョ雉锃殒窘灬忮飑ē熹ē沩ē忭灬忮飑ē忮灬忮飑ㄤ彐躅ョ雉锃殒灬忮飑ē熹ē沩ē忭灬忮飑ㄤ彐躅ョ雉锃殒灬忮飑ē熹ē沩ē怵灬忮飑ㄤ彐躅ョ雉锃殒冀灬忮飑ē熹ē沩ē怵灬忮飑ē忮灬忮飑ㄤ彐躅ョ雉锃殒铒灬忮飑ē熹ē忮灬忮飑ㄤ彐躅ラ钽ㄤ邈灬蝈扉篝┅ē熹ㄡ箜洪钽横沣蹴蹯狒矧ē篝┅ㄤ彐躅ヤ邈ㄤ邈灬蝈扉篝┅ē熹ㄡ箜轰邈横沣蹴蹯狒矧ē篝┅ㄤ彐躅狍愍镳狎绌ㄦ狎瀛磲翥桢蚝磲翥狎è镦豉疱铛礅弪ㄡ箜镳洪眄邃獒翦狎绌è扉篝篝矧徵瀛沆狍徜潋ㄥ汜箦篝矧徵瀛沆狍ê篝徙ㄡ箜镳后翎汶轭溴邃徜潋┅ê珈镡犰ㄡ箜镳横怏镬豸徜潋┅┅┅ㄤ彐躅キㄡ箜后邈洪眇扉邃ē熹ㄡ箜后忏┅ㄤ彐躅カㄡ箜恒煦洪眇扉邃ē熹ㄡ箜横溷┅